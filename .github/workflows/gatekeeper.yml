name: Gatekeeper

on:
  workflow_dispatch:
#  schedule:
#    - cron: '30 16 * * *'

env:
  IMAGE: ghcr.io/nayetdet/gatekeeper:latest
  BRANCH_NAME: state

jobs:
  gatekeeper:
    runs-on: ubuntu-latest
    timeout-minutes: 8
    permissions:
      contents: write
    concurrency:
      group: gatekeeper
      cancel-in-progress: false

    steps:
      - name: Validate repository visibility
        run: |
          if [[ "${{ github.event.repository.private }}" != "true" ]]; then
            echo "This workflow must be run in a private repository"
            exit 0
          fi

      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Git identity
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Set up state branch
        run: |
          git fetch origin --prune
          if git ls-remote --exit-code --heads origin "$BRANCH_NAME" >/dev/null 2>&1; then
            git checkout "$BRANCH_NAME"
          else
            git checkout --orphan "$BRANCH_NAME"
            git rm -rf .
            mkdir -p data
            touch data/.gitkeep
            git add data/.gitkeep
            git commit -m "chore: initialize state branch"
            git push -u origin "$BRANCH_NAME"
          fi

      - name: Pull container image
        run: docker pull ${{ env.IMAGE }}

      - name: Run Gatekeeper container
        env:
          EPIC_GAMES_EMAIL: ${{ secrets.EPIC_GAMES_EMAIL }}
          EPIC_GAMES_PASSWORD: ${{ secrets.EPIC_GAMES_PASSWORD }}
          EPIC_GAMES_LOCALE: ${{ secrets.EPIC_GAMES_LOCALE }}
          EPIC_GAMES_COUNTRY: ${{ secrets.EPIC_GAMES_COUNTRY }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          docker run \
            --init \
            --rm \
            --memory=4g \
            --shm-size=2g \
            -e EPIC_GAMES_EMAIL \
            -e EPIC_GAMES_PASSWORD \
            -e EPIC_GAMES_LOCALE \
            -e EPIC_GAMES_COUNTRY \
            -e GEMINI_API_KEY \
            -v "$PWD/data:/app/data" \
            ${{ env.IMAGE }}

      - name: Fix ownership and permissions on data volume
        if: always()
        run: |
          sudo chown -R "$(id -u):$(id -g)" data
          sudo chmod -R u+rwX data

      - name: Persist data volume to state branch
        if: always()
        run: |
          git add data
          if ! git diff --cached --quiet; then
            git commit --amend -m "state: persist gatekeeper run $(date -u +'%Y-%m-%dT%H:%M:%SZ')"
            git push --force-with-lease origin "$BRANCH_NAME"
          fi
